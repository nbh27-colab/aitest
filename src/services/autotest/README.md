# AutoTest Service vá»›i LangGraph & Playwright

Service tá»± Ä‘á»™ng test web application sá»­ dá»¥ng LangGraph workflow vÃ  Playwright automation.

## ğŸ¯ Äáº·c Ä‘iá»ƒm

- **Sequential Execution**: Generate vÃ  execute tá»«ng substep má»™t, dá»±a trÃªn context hiá»‡n táº¡i
- **Context Awareness**: Má»—i substep Ä‘Æ°á»£c generate dá»±a trÃªn tráº¡ng thÃ¡i thá»±c táº¿ cá»§a page
- **LLM-Powered**: Sá»­ dá»¥ng GPT-4 Vision Ä‘á»ƒ phÃ¢n tÃ­ch UI vÃ  generate test steps
- **Adaptive**: Tá»± Ä‘á»™ng Ä‘iá»u chá»‰nh dá»±a trÃªn nhá»¯ng gÃ¬ thá»±c sá»± xáº£y ra trÃªn page

## ğŸ”§ CÃ i Ä‘áº·t

```bash
# Install dependencies
pip install -r requirements.txt

# Install Playwright browsers
playwright install chromium
```

## ğŸ“ Cáº¥u hÃ¬nh

Táº¡o file `.env` hoáº·c set environment variable:

```bash
OPENAI_API_KEY=your_openai_api_key_here
```

## ğŸš€ Sá»­ dá»¥ng

### API Endpoint

**POST** `/api/autotest/run`

Request body:
```json
{
  "test_case_id": 1,
  "login_info_id": 1,
  "openai_api_key": "sk-..." // optional náº¿u Ä‘Ã£ set trong env
}
```

Response:
```json
{
  "status": "success",
  "message": "Autotest completed with status: passed",
  "test_case_id": 1,
  "result": {
    "status": "passed",
    "total_steps": 3,
    "total_substeps": 8,
    "passed_substeps": 8,
    "failed_substeps": 0,
    "generated_scripts": [101, 102, 103, ...],
    "execution_results": [...]
  }
}
```

### Programmatic Usage

```python
from src.services.autotest.workflow import AutoTestWorkflow
from sqlalchemy.orm import Session

# Create workflow
workflow = AutoTestWorkflow(
    db_session=db,
    minio_client=minio_client,
    openai_api_key="sk-..."
)

# Run autotest
result = await workflow.run(
    test_case_id=1,
    login_info_id=1
)

print(f"Status: {result['status']}")
print(f"Passed: {result['passed_substeps']}/{result['total_substeps']}")
```

## ğŸ”„ Workflow

```
1. INITIALIZE
   â†“
2. AUTO_LOGIN (Navigate + Login)
   â†“
3. GET_CONTEXT (Extract page state)
   â†“
4. GENERATE_SUBSTEP (LLM generate next action)
   â†“
5. EXECUTE_SUBSTEP (Run Playwright script)
   â†“
6. Decision:
   - More substeps? â†’ GO TO 3
   - Next step? â†’ GO TO 3
   - Done? â†’ CLEANUP
```

## ğŸ“Š Database Schema

### Tables Used

- `test_cases`: Test case chÃ­nh
- `step`: CÃ¡c bÆ°á»›c trong test case
- `sub_step`: **Generated** - Chi tiáº¿t substeps Ä‘Æ°á»£c LLM táº¡o ra
- `login_info`: ThÃ´ng tin Ä‘Äƒng nháº­p
- `generated_script`: **Generated** - Playwright scripts
- `screenshot`: Screenshots tá»« execution
- `test_result`: Káº¿t quáº£ test

### Flow

```
TestCase
  â””â”€> Steps (manual)
       â””â”€> SubSteps (auto-generated by LLM)
            â””â”€> GeneratedScript (Playwright code)
                 â””â”€> Screenshot (execution evidence)
                 â””â”€> TestResult (pass/fail)
```

## ğŸ¨ VÃ­ dá»¥

### Input (Manual)

**Test Case**: "Äáº·t hÃ ng sáº£n pháº©m iPhone"

**Steps** (ngÆ°á»i dÃ¹ng táº¡o):
1. Step 1: "ÄÄƒng nháº­p há»‡ thá»‘ng"
   - Expected: "Hiá»ƒn thá»‹ dashboard"
2. Step 2: "TÃ¬m kiáº¿m sáº£n pháº©m iPhone 15"
   - Expected: "Hiá»ƒn thá»‹ danh sÃ¡ch sáº£n pháº©m"
3. Step 3: "ThÃªm vÃ o giá» hÃ ng"
   - Expected: "Giá» hÃ ng cÃ³ 1 sáº£n pháº©m"

**Login Info**:
- web_url: "https://shop.example.com"
- email: "test@example.com"
- password: "password123"

### Output (Auto-generated)

**Step 2 â†’ Generated SubSteps**:

1. SubStep 1: "Click vÃ o Ã´ tÃ¬m kiáº¿m"
   - Generated Script: `await page.click('#search-box')`
   - Result: âœ“ Success

2. SubStep 2: "Nháº­p tá»« khÃ³a 'iPhone 15'"
   - Generated Script: `await page.fill('#search-input', 'iPhone 15')`
   - Result: âœ“ Success

3. SubStep 3: "Click vÃ o suggestion Ä‘áº§u tiÃªn"
   - Generated Script: `await page.click('.autocomplete-item:first-child')`
   - Result: âœ“ Success

4. SubStep 4: "Verify káº¿t quáº£ hiá»ƒn thá»‹"
   - Generated Script: `assert await page.locator('.product-card').count() > 0`
   - Result: âœ“ Success

## ğŸ” Monitoring

### Check Status

**GET** `/api/autotest/status/{test_case_id}`

Response:
```json
{
  "test_case_id": 1,
  "total_results": 8,
  "results": [
    {
      "object_id": 101,
      "result": true,
      "reason": "Click vÃ o Ã´ tÃ¬m kiáº¿m - completed successfully",
      "created_at": "2025-11-16T10:30:00"
    },
    ...
  ]
}
```

## ğŸ› Debugging

### Enable Headed Mode

Trong `nodes.py`, file `initialize()`:

```python
self.browser = await self.playwright_context.chromium.launch(
    headless=False,  # See browser
    slow_mo=1000     # Slow down actions
)
```

### Check Generated Scripts

Scripts Ä‘Æ°á»£c lÆ°u trong table `generated_script`:

```sql
SELECT gs.generated_script_id, gs.script_content, ss.sub_step_content
FROM qa_test.generated_script gs
JOIN qa_test.sub_step ss ON gs.sub_step_id = ss.sub_step_id
ORDER BY gs.created_at DESC;
```

### View Screenshots

Screenshots Ä‘Æ°á»£c lÆ°u local (sáº½ upload MinIO sau):

```bash
ls -la *.png
```

## âš™ï¸ Configuration

### LLM Model

Trong `llm_generator.py`:

```python
LLMGenerator(
    api_key=api_key,
    model="gpt-4o"  # or "gpt-4-turbo", "gpt-4o-mini"
)
```

### Playwright Options

Trong `nodes.py`:

```python
self.browser = await self.playwright_context.chromium.launch(
    headless=True,
    slow_mo=500,
    args=['--no-sandbox']  # For Docker
)
```

## ğŸ“ TODO

- [ ] Integrate MinIO upload cho screenshots
- [ ] Add retry logic cho failed substeps
- [ ] Implement critical step detection
- [ ] Add support for file upload actions
- [ ] Support multiple browser contexts
- [ ] Add visual regression testing
- [ ] Generate HTML test report

## ğŸ¤ Contributing

Workflow nÃ y follow pattern:
1. Context extraction â†’ 2. LLM generation â†’ 3. Execution â†’ 4. Verification
Loop cho Ä‘áº¿n khi hoÃ n thÃ nh táº¥t cáº£ steps.

Má»—i substep Ä‘á»™c láº­p vÃ  cÃ³ context Ä‘áº§y Ä‘á»§ tá»« tráº¡ng thÃ¡i page hiá»‡n táº¡i.
